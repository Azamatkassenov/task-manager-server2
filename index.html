<!DOCTYPE html>
<html>
<head>
    <title>Менеджер задач</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #company-name {
            font-size: 2em; /* Увеличим размер текста */
            font-weight: bold; /* Сделаем текст жирным */
            margin-bottom: 10px; /* Добавим отступ снизу */
            text-align: center; /* Центрируем текст по горизонтали */
            width: 100%; /* Занимаем всю ширину контейнера */
            background-color: rgb(56, 56, 270); /* Светлее синий фон */
            color: white; /* Белый цвет текста */
            padding: 10px 0; /* Добавим немного отступов сверху и снизу */
        }
        #task-list-container {
            flex: 1;
            margin-right: 0;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        /* Стили для статусов задач */
        .status-pending {
            background-color: lightyellow;
        }
        .status-completed {
            background-color: lightgreen;
        }
        .status-rejected {
            background-color: lightgrey;
        }
        .comment-cell {
            min-width: 200px;
        }
        .comment-input {
            width: 100%;
            box-sizing: border-box;
            overflow-y: auto;
            resize: none;
            min-height: 30px;
            max-height: 200px;
        }
        #employee-management {
            width: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        #employee-list {
            list-style-type: none;
            padding: 0;
            margin: 5px 0;
        }
        #employee-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #employee-list li:last-child {
            border-bottom: none;
        }
        #employee-list li button {
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="task-list-container">
        <div id="company-name">Управляющая компания ТОО "HalykService"</div>
        <h1>Менеджер задач</h1>
        <div id="input-area">
            <label for="task-input">Новая задача:</label>
            <input type="text" id="task-input">
            <label for="priority-select">Приоритет:</label>
            <select id="priority-select">
                <option value="low">Низкий</option>
                <option value="medium">Средний</option>
                <option value="high">Высокий</option>
            </select>
            <button onclick="addTask()">Добавить задачу</button>
        </div>
        <table id="task-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Задача</th>
                    <th>Приоритет</th>
                    <th>Выполнил</th>
                    <th>Комментарий</th>
                    <th>Статус</th>
                    <th>Время поступления</th>
                    <th>Время закрытия</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
       <div id="statistics">
            <h2>Статистика</h2>
            <p>Выполнено: <span id="completed-count">0</span></p>
            <p>Не выполнено: <span id="pending-count">0</span></p>
            <p>Отклонено: <span id="rejected-count">0</span></p>
        </div>
    </div>
    <div id="employee-management">
        <h2>Сотрудники</h2>
        <input type="text" id="employee-input" placeholder="Добавить сотрудника">
        <button onclick="addEmployee()">Добавить</button>
        <ul id="employee-list">
            </ul>
    </div>
    <script>
        console.log('Менеджер задач инициализирован.');

        class Task {
            constructor(id, text, priority, color = '#FFFFFF', status = 'pending', executor = '', comments = [], creationTime = new Date().toISOString(), completionTime = null) {
                this.id = id;
                this.text = text;
                this.priority = priority;
                this.color = color;
                this.status = status;
                this.executor = executor;
                this.comments = comments ? comments.map(c => c.trim()) : [];
                this.creationTime = creationTime || new Date().toISOString();
                this.completionTime = completionTime;
            }
        }

        class Employee {
            constructor(name) {
                this.name = name;
            }
        }

        let tasks = [];
        let taskIdCounter = 1;
        let employees = [];

        const taskTableBody = document.querySelector('#task-table tbody');
        const completedCountSpan = document.getElementById('completed-count');
        const pendingCountSpan = document.getElementById('pending-count');
        const rejectedCountSpan = document.getElementById('rejected-count');
        const taskInput = document.getElementById('task-input');
        const employeeInput = document.getElementById('employee-input');
        const employeeList = document.getElementById('employee-list');

        // --- Функции сохранения и загрузки данных ---
        const saveTasks = () => {
            try {
                console.log('saveTasks - tasks перед сохранением:', tasks);
                const tasksString = JSON.stringify(tasks);
                console.log('saveTasks - строка для сохранения:', tasksString);
                // localStorage.setItem('tasks' // Заменено на POST, tasksString);
                console.log('Задачи сохранены:', tasks);
            } catch (error) {
                console.error('Ошибка при сохранении задач:', error);
            }
        };

        const loadTasks = () => {
            const storedTasks = // localStorage.getItem('tasks') // Заменено на fetch;
            console.log('loadTasks - storedTasks:', storedTasks);
            if (storedTasks) {
                try {
                    console.log('loadTasks - storedTasks до парсинга:', storedTasks);
                    const parsedTasks = JSON.parse(storedTasks);
                    console.log('loadTasks - parsedTasks:', parsedTasks);
                    tasks = parsedTasks.map(taskData => new Task(
                        taskData.id,
                        taskData.text,
                        taskData.priority,
                        taskData.color,
                        taskData.status,
                        taskData.executor,
                        taskData.comments,
                        taskData.creationTime,
                        taskData.completionTime
                    ));
                    taskIdCounter = tasks.reduce((max, task) => Math.max(max, task.id), 0) + 1;
                    console.log('Задачи загружены:', tasks);
                } catch (error) {
                    console.error('Ошибка при загрузке задач:', error);
                    tasks = [];
                }
            } else {
                tasks = [];
                console.log('Хранилище задач пусто.');
            }
        };

        const saveEmployees = () => {
            try {
                localStorage.setItem('employees', JSON.stringify(employees));
                console.log('Сотрудники сохранены:', employees);
            } catch (error) {
                console.error('Ошибка при сохранении сотрудников:', error);
            }
        };

        const loadEmployees = () => {
            const storedEmployees = localStorage.getItem('employees');
            if (storedEmployees) {
                try {
                    employees = JSON.parse(storedEmployees).map(empData => new Employee(empData.name));
                    console.log('Сотрудники загружены:', employees);
                } catch (error) {
                    console.error('Ошибка при загрузке сотрудников:', error);
                    employees = [];
                }
            } else {
                employees = [];
                console.log('Хранилище сотрудников пусто.');
            }
        };

        // --- Вспомогательные функции ---
        const formatDate = (isoDate) => {
            if (!isoDate) return '';
            const date = new Date(isoDate);
            return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        };

        const updateStatistics = () => {
            const completed = tasks.filter(task => task.status === 'completed').length;
            const pending = tasks.filter(task => task.status === 'pending').length;
            const rejected = tasks.filter(task => task.status === 'rejected').length;
            completedCountSpan.textContent = completed;
            pendingCountSpan.textContent = pending;
            rejectedCountSpan.textContent = rejected;
        };

        const renderEmployeeList = () => {
            employeeList.innerHTML = '';
            employees.forEach(employee => {
                const li = document.createElement('li');
                li.textContent = employee.name;
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Удалить';
                deleteButton.onclick = () => deleteEmployee(employee.name);
                li.appendChild(deleteButton);
                employeeList.appendChild(li);
            });
            renderTasks(); // Обновляем список исполнителей в задачах
        };

        const getTaskRowId = (taskId) => `task-row-${taskId}`;

        // --- Функции управления задачами ---
        const addTask = () => {
            const taskText = taskInput.value.trim();
            const priority = document.getElementById('priority-select').value;
            if (taskText) {
                const newTask = new Task(taskIdCounter++, taskText, priority);
                tasks.push(newTask);
                console.log('addTask - новая задача:', newTask);
                saveTasks();
                renderTasks();
                taskInput.value = '';
                console.log('addTask - задачи после добавления:', tasks);
            }
        };

        const updateTaskPriority = (taskId, newPriority) => {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.priority = newPriority;
                saveTasks();
                renderTasks();
                console.log('Приоритет задачи обновлен:', taskId, newPriority);
            }
        };

        const updateTaskStatus = (taskId, status) => {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = status;
                task.completionTime = status === 'completed' || status === 'rejected' ? new Date().toISOString() : null;
                saveTasks();
                renderTasks();
                console.log('Статус задачи обновлен:', taskId, status);
            }
        };

        const updateTaskExecutor = (taskId, executor) => {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.executor = executor;
                saveTasks();
                renderTasks();
                console.log('Исполнитель задачи обновлен:', taskId, executor);
            }
        };

        const addComment = (taskId, commentText) => {
            const task = tasks.find(t => t.id === taskId);
            if (task && commentText.trim()) {
                task.comments = commentText.trim().split(',').map(c => c.trim());
                saveTasks();
                renderTasks();
                console.log('Комментарий добавлен к задаче:', taskId, commentText);
            }
        };

        const deleteTask = (taskId) => {
            tasks = tasks.filter(task => task.id !== taskId);
            saveTasks();
            renderTasks();
            console.log('Задача удалена:', taskId);
        };

        const renderTasks = () => {
            console.log('renderTasks - начало, tasks:', tasks);
            taskTableBody.innerHTML = '';
            if (!tasks || tasks.length === 0) {
                console.log('renderTasks - нет задач для отображения.');
                updateStatistics();
                return;
            }
            tasks.sort((a, b) => {
                const statusOrder = { pending: 1, completed: 2, rejected: 3 };
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                const statusComparison = (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
                if (statusComparison !== 0) return statusComparison;
                const priorityComparison = priorityOrder[b.priority] - priorityOrder[a.priority];
                if (priorityComparison !== 0) return priorityComparison;
                return a.id - b.id;
            }).forEach(task => {
                console.log('renderTasks - отрисовываем задачу:', task);
                const row = taskTableBody.insertRow();
                row.classList.add(`status-${task.status}`);
                row.id = getTaskRowId(task.id);

                row.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.text}</td>
                    <td>
                        <select onchange="updateTaskPriority(${task.id}, this.value)" ${task.status === 'completed' || task.status === 'rejected' ? 'disabled' : ''} style="background-color: ${task.status === 'completed' || task.status === 'rejected' ? '#cccccc' : ''}">
                            <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Низкий</option>
                            <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Средний</option>
                            <option value="high" ${task.priority === 'high' ? 'selected' : ''}>Высокий</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateTaskExecutor(${task.id}, this.value)" ${task.status === 'completed' || task.status === 'rejected' ? 'disabled' : ''} style="background-color: ${task.status === 'completed' || task.status === 'rejected' ? '#cccccc' : ''}">
                            <option value="">Выберите сотрудника</option>
                            ${employees.map(emp => `<option value="${emp.name}" ${task.executor === emp.name ? 'selected' : ''}>${emp.name}</option>`).join('')}
                        </select>
                    </td>
                    <td class="comment-cell">
                        <textarea class="comment-input" placeholder="Добавить комментарий" onblur="addComment(${task.id}, this.value)">${task.comments.join(', ')}</textarea>
                    </td>
                    <td>
                        <select class="task-status" onchange="updateTaskStatus(${task.id}, this.value)" ${task.status === 'completed' || task.status === 'rejected' || !task.executor ? 'disabled' : ''} style="background-color: ${task.status === 'completed' || task.status === 'rejected' || !task.executor ? '#cccccc' : ''}">
                            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Не выполнено</option>
                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Выполнено</option>
                        <option value="rejected" ${task.status === 'rejected' ? 'selected' : ''}>Отклонено</option>
                    </select>
                </td>
                <td>${formatDate(task.creationTime)}</td>
                <td>${formatDate(task.completionTime)}</td>
                <td><button onclick="deleteTask(${task.id})">Удалить</button></td>
                `;
            });
            updateStatistics();
            console.log('renderTasks - конец.');
        };

        // --- Функции управления сотрудниками ---
        const addEmployee = () => {
            const employeeName = employeeInput.value.trim();
            if (employeeName && !employees.find(emp => emp.name === employeeName)) {
                employees.push(new Employee(employeeName));
                saveEmployees();
                renderEmployeeList();
                renderTasks(); // Обновляем список исполнителей в задачах
                employeeInput.value = '';
                console.log('Сотрудник добавлен:', employeeName);
            }
        };

        const deleteEmployee = (employeeName) => {
            employees = employees.filter(emp => emp.name !== employeeName);
            saveEmployees();
            renderEmployeeList();
            renderTasks(); // Обновляем список исполнителей в задачах
            console.log('Сотрудник удален:', employeeName);
        };

        // --- Инициализация ---
        loadTasks();
        loadEmployees();
        renderEmployeeList();
        renderTasks(); // Первоначальная отрисовка задач

        // --- Обработчики событий ---
        taskInput.addEventListener('keypress', event => { if (event.key === 'Enter') addTask(); });
        employeeInput.addEventListener('keypress', event => { if (event.key === 'Enter') addEmployee(); });

        console.log('Менеджер задач готов к работе.');
    </script>
</body>
</html>